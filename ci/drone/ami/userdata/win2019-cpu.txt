<powershell>
$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest
function Check-Call {
    param (
        [scriptblock]$ScriptBlock
    )
    Write-Host "Executing $ScriptBlock"
    & @ScriptBlock
    if (($lastexitcode -ne 0)) {
        Write-Error "Execution failed with $lastexitcode"
        exit $lastexitcode
    }
}
Set-ExecutionPolicy Bypass -Scope Process -Force

Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
Start-Service sshd
Set-Service -Name sshd -StartupType 'Automatic'

# install chocolatey
Invoke-WebRequest -Uri https://chocolatey.org/install.ps1 -OutFile install.ps1
./install.ps1
refreshenv
Remove-Item -path ./install.ps1 -force

# install dependencies
Check-Call { C:\ProgramData\chocolatey\choco install python --version=3.7.0 --force -y --no-progress }
refreshenv
Check-Call { C:\Python37\python -m pip install --upgrade pip  }
Invoke-WebRequest -Uri https://raw.githubusercontent.com/aiengines/ci/master/ami_generation/windows/requirements.txt -OutFile requirements.txt
Check-Call { C:\Python37\python -m pip install -r requirements.txt  }

Check-Call { C:\ProgramData\chocolatey\choco install git -y }
Check-Call { C:\ProgramData\chocolatey\choco install 7zip -y }
Check-Call { C:\ProgramData\chocolatey\choco install cmake -y }
Check-Call { C:\ProgramData\chocolatey\choco install ninja -y }
refreshenv
Check-Call { C:\ProgramData\chocolatey\choco install javaruntime -y }
refreshenv

Invoke-WebRequest -Uri https://raw.githubusercontent.com/apache/incubator-mxnet/254499b61e31ddb91f25836d9446c387fb0af5b4/ci/windows_dev_env/windows_deps_headless_installer.py -OutFile windows_deps_headless_installer.py
Check-Call { C:\Python37\python windows_deps_headless_installer.py }

$progressPreference = 'silentlyContinue'
Invoke-WebRequest -Uri https://windows-post-install.s3-us-west-2.amazonaws.com/slave-autoconnect.py -OutFile C:\slave-autoconnect.py
Invoke-WebRequest -Uri https://windows-post-install.s3-us-west-2.amazonaws.com/run-auto-connect.bat -OutFile C:\run-auto-connect.bat
$trigger = New-ScheduledTaskTrigger -AtStartup -RandomDelay 00:00:30
$action = New-ScheduledTaskAction -Execute C:\run-auto-connect.bat
$principal = New-ScheduledTaskPrincipal -UserID "NT AUTHORITY\SYSTEM" -LogonType ServiceAccount -RunLevel Highest
Register-ScheduledTask "JenkinsAutoConnect" -Description "Connect to Jenkins at startup" -Action $action -Trigger $trigger -Principal $principal

# create required directories
New-Item -ItemType directory -Path C:\jenkins_slave
New-Item -ItemType directory -Path C:\jenkins_slave\workspace

Check-Call { C:\ProgramData\Amazon\EC2-Windows\Launch\Scripts\InitializeInstance.ps1 -Schedule }
Stop-Computer -ComputerName localhost -Force
</powershell>
